
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Game 2048 Environment and DQN Agent &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '2048-solver/solver';</script>
    <link rel="icon" href="../_static/icon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to Saralsyâ€™s Learning Projects
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../iris-data.html">Iris Species</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boston-house.html">Boston House Prices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sonar-mines.html">Connectionist Bench (Sonar, Mines vs. Rocks)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../store-sales-time-series-forecasting/store-sales.html">Store Sales - Time Series Forecasting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../titanic-decision-tree/titanic-decision-tree.html">Titanic Survival Prediction using Decision Trees</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2F2048-solver/solver.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/2048-solver/solver.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Game 2048 Environment and DQN Agent</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Game 2048 Environment and DQN Agent</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#training-loop">Training Loop</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pygame-visualizer-for-dqn-agent">2048 PyGame Visualizer for DQN Agent</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expectimax-algorithm">Expectimax Algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pygame-visualizer-for-expectimax-algorithm">PyGame Visualizer for Expectimax Algorithm</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip3<span class="w"> </span>install<span class="w"> </span>torch<span class="w"> </span>torchvision<span class="w"> </span>numpy
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: torch in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (2.7.1)
Requirement already satisfied: torchvision in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (0.22.1)
Requirement already satisfied: numpy in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (1.26.4)
Requirement already satisfied: filelock in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (from torch) (3.18.0)
Requirement already satisfied: typing-extensions&gt;=4.10.0 in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (from torch) (4.12.2)
Requirement already satisfied: sympy&gt;=1.13.3 in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (from torch) (1.14.0)
Requirement already satisfied: networkx in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (from torch) (3.2.1)
Requirement already satisfied: jinja2 in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (from torch) (3.1.4)
Requirement already satisfied: fsspec in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (from torch) (2024.12.0)
Requirement already satisfied: pillow!=8.3.*,&gt;=5.3.0 in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (from torchvision) (10.4.0)
Requirement already satisfied: mpmath&lt;1.4,&gt;=1.1.0 in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (from sympy&gt;=1.13.3-&gt;torch) (1.3.0)
Requirement already satisfied: MarkupSafe&gt;=2.0 in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (from jinja2-&gt;torch) (2.1.5)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> A new release of pip is available: <span class=" -Color -Color-Red">24.1</span> -&gt; <span class=" -Color -Color-Green">25.1.1</span>
<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> To update, run: <span class=" -Color -Color-Green">pip install --upgrade pip</span>
</pre></div>
</div>
</div>
</div>
<section id="game-2048-environment-and-dqn-agent">
<h1>Game 2048 Environment and DQN Agent<a class="headerlink" href="#game-2048-environment-and-dqn-agent" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="k">class</span> <span class="nc">Game2048Env</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_tile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_tile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="k">else</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">_move_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">new_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">score_increase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">merged_line</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_line</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span> <span class="ow">and</span> <span class="n">new_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_line</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">merged_value</span> <span class="o">=</span> <span class="n">new_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">merged_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged_value</span><span class="p">)</span>
                <span class="n">score_increase</span> <span class="o">+=</span> <span class="n">merged_value</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">merged_line</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_line</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">merged_line</span><span class="p">),</span> <span class="n">score_increase</span>

    <span class="k">def</span> <span class="nf">_move_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="n">board</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">total_reward</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rotated_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rotated_board</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rotated_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">new_line</span><span class="p">,</span> <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">new_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_line</span>
            <span class="n">total_reward</span> <span class="o">+=</span> <span class="n">reward</span>
        <span class="n">final_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_board</span><span class="p">,</span> <span class="n">total_reward</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{}</span>
        <span class="n">new_board</span><span class="p">,</span> <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_board</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">new_board</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_tile</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="n">reward</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">reward</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">,</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="n">rotated_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
        <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rotated_board</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rotated_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">new_line</span><span class="p">,</span> <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">new_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_line</span>
        <span class="n">final_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="n">action</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_board</span>
    
    <span class="k">def</span> <span class="nf">get_valid_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">temp_board</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
             <span class="c1"># Apply the move logic manually</span>
            <span class="n">rotated_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">temp_board</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
            <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rotated_board</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">rotated_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">new_line</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">new_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_line</span>
            <span class="n">final_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="n">action</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">final_board</span><span class="p">,</span> <span class="n">temp_board</span><span class="p">):</span>
                <span class="n">valid_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">valid_actions</span>

    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="c1"># --- Optimized Environment ---</span>
<span class="k">class</span> <span class="nc">Game2048Env</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_tile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_tile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="k">else</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">_move_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">new_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">score_increase</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">merged_line</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_line</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span> <span class="ow">and</span> <span class="n">new_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_line</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">merged_value</span> <span class="o">=</span> <span class="n">new_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">merged_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged_value</span><span class="p">)</span>
                <span class="n">score_increase</span> <span class="o">+=</span> <span class="n">merged_value</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">merged_line</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_line</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">merged_line</span><span class="p">),</span> <span class="n">score_increase</span>

    <span class="k">def</span> <span class="nf">_move_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="n">board</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">total_reward</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rotated_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rotated_board</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rotated_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">new_line</span><span class="p">,</span> <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">new_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_line</span>
            <span class="n">total_reward</span> <span class="o">+=</span> <span class="n">reward</span>
        <span class="n">final_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_board</span><span class="p">,</span> <span class="n">total_reward</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{}</span>
        <span class="n">new_board</span><span class="p">,</span> <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_board</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">new_board</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_tile</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="n">reward</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">reward</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">,</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="n">rotated_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
        <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rotated_board</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rotated_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">new_line</span><span class="p">,</span> <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">new_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_line</span>
        <span class="n">final_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="n">action</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_board</span>
    
    <span class="k">def</span> <span class="nf">get_valid_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">temp_board</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
             <span class="c1"># Apply the move logic manually</span>
            <span class="n">rotated_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">temp_board</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
            <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rotated_board</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">rotated_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">new_line</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">new_board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_line</span>
            <span class="n">final_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="n">action</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">final_board</span><span class="p">,</span> <span class="n">temp_board</span><span class="p">):</span>
                <span class="n">valid_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">valid_actions</span>

    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>

<span class="c1"># --- One-Hot Board Encoding ---</span>
<span class="k">def</span> <span class="nf">encode_board</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="mi">16</span> 
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">channels</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">board</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">channels</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1"># --- CNN-Based DQN ---</span>
<span class="k">class</span> <span class="nc">CNN_DQN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="c1"># --- OPTIMIZATION 1: Prioritized Experience Replay (PER) Buffer ---</span>
<span class="k">class</span> <span class="nc">PrioritizedReplayBuffer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="n">max_prio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="k">else</span> <span class="mf">1.0</span>
        
        <span class="n">experience</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experience</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="n">experience</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_prio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
            <span class="n">prios</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prios</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">]</span>
        
        <span class="n">probs</span> <span class="o">=</span> <span class="n">prios</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">probs</span> <span class="o">/=</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">*</span> <span class="n">probs</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">/=</span> <span class="n">weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">samples</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_priorities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_indices</span><span class="p">,</span> <span class="n">batch_priorities</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prio</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch_indices</span><span class="p">,</span> <span class="n">batch_priorities</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">prio</span> <span class="o">+</span> <span class="mf">1e-5</span> <span class="c1"># Add epsilon to avoid zero priority</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>


<span class="c1"># --- Agent with Double DQN ---</span>
<span class="k">class</span> <span class="nc">Agent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">2.5e-5</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">max_memory</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">epsilon_start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">epsilon_min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">epsilon_decay</span><span class="o">=</span><span class="mf">0.9995</span><span class="p">,</span> <span class="n">per_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">per_beta_start</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">per_beta_frames</span><span class="o">=</span><span class="mi">200000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_net</span> <span class="o">=</span> <span class="n">CNN_DQN</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span> <span class="o">=</span> <span class="n">CNN_DQN</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">PrioritizedReplayBuffer</span><span class="p">(</span><span class="n">max_memory</span><span class="p">,</span> <span class="n">per_alpha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_min</span> <span class="o">=</span> <span class="n">epsilon_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_decay</span> <span class="o">=</span> <span class="n">epsilon_decay</span>

        <span class="c1"># Beta for PER importance sampling, annealed from start to 1 over training frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_beta</span> <span class="o">=</span> <span class="n">per_beta_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_beta_start</span> <span class="o">=</span> <span class="n">per_beta_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_beta_frames</span> <span class="o">=</span> <span class="n">per_beta_frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Learning rate scheduler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_steps</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Training monitoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;losses&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;td_errors&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;q_values_mean&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;targets_mean&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;rewards_mean&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;gradient_norms&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_beta_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_idx</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_beta_start</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_beta_frames</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_board</span><span class="p">,</span> <span class="n">valid_actions</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
             <span class="k">return</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">state_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">encode_board</span><span class="p">(</span><span class="n">state_board</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_net</span><span class="p">(</span><span class="n">state_tensor</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">masked_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">q_values</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="n">masked_q</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_values</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">masked_q</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_beta</span><span class="p">()</span>
        <span class="n">batch</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
        <span class="n">states</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">next_states</span><span class="p">,</span> <span class="n">dones</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">states_enc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">encode_board</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">states</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">next_states_enc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">encode_board</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">next_states</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">rewards</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">dones</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dones</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Calculate Q-values for the current state</span>
        <span class="n">q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_net</span><span class="p">(</span><span class="n">states_enc</span><span class="p">)</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">actions</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate Q-values for the next state</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">next_q_values_online</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_net</span><span class="p">(</span><span class="n">next_states_enc</span><span class="p">)</span>
            <span class="c1"># Get the best action for the next state</span>
            <span class="n">best_next_actions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">next_q_values_online</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Get the Q-values for the best action for the next state</span>
            <span class="n">next_q_values_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span><span class="p">(</span><span class="n">next_states_enc</span><span class="p">)</span>
            <span class="n">next_q_target</span> <span class="o">=</span> <span class="n">next_q_values_target</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">best_next_actions</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">rewards</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">next_q_target</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dones</span><span class="p">)</span>

        <span class="c1"># Calculate the TD errors (target - q_values)</span>
        <span class="n">td_errors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">targets</span> <span class="o">-</span> <span class="n">q_values</span><span class="p">)</span>

        <span class="c1"># Calculate the loss</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">q_values</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Update the Q-network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">gradient_norms</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># Update the learning rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_steps</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Store the training stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_training_stats</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">td_errors</span><span class="p">,</span> <span class="n">q_values</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">gradient_norms</span><span class="p">)</span>

        <span class="c1"># Update the PER priorities</span>
        <span class="n">priorities</span> <span class="o">=</span> <span class="n">td_errors</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">update_priorities</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">priorities</span><span class="p">)</span>

    
    <span class="c1"># store the training stats</span>
    <span class="k">def</span> <span class="nf">store_training_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">td_errors</span><span class="p">,</span> <span class="n">q_values</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">gradient_norms</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;losses&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;td_errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">td_errors</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;q_values_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>  <span class="c1"># Take mean first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;targets_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>    <span class="c1"># Take mean first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;rewards_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>    <span class="c1"># Take mean first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;gradient_norms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gradient_norms</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">get_training_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get summary statistics of recent training&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;losses&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="n">recent_losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;losses&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>  <span class="c1"># Last 100 training steps</span>
        <span class="n">recent_td_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;td_errors&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
        <span class="n">recent_q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;q_values_mean&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
        <span class="n">recent_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;targets_mean&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
        <span class="n">recent_rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;rewards_mean&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
        <span class="n">recent_gradient_norms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;gradient_norms&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recent_losses</span><span class="p">),</span>
            <span class="s1">&#39;avg_td_error&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recent_td_errors</span><span class="p">),</span>
            <span class="s1">&#39;loss_trend&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recent_losses</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">:])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recent_losses</span><span class="p">[:</span><span class="mi">20</span><span class="p">]),</span>  <span class="c1"># Positive = increasing</span>
            <span class="s1">&#39;td_error_trend&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recent_td_errors</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">:])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recent_td_errors</span><span class="p">[:</span><span class="mi">20</span><span class="p">]),</span>
            <span class="s1">&#39;total_training_steps&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_stats</span><span class="p">[</span><span class="s1">&#39;losses&#39;</span><span class="p">])</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">update_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">decay_epsilon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_decay</span><span class="p">)</span>


<span class="c1"># --- Reward Shaping ---</span>
<span class="k">def</span> <span class="nf">get_shaped_reward</span><span class="p">(</span><span class="n">reward_from_env</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">prev_board</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">reward_from_env</span> <span class="o">==</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span>  <span class="c1"># Invalid move</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">10.0</span>
    
    <span class="c1"># Base reward from merges</span>
    <span class="n">log_reward</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">reward_from_env</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log_reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">reward_from_env</span><span class="p">)</span>
    
    <span class="c1"># Bonus for reaching higher tiles</span>
    <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="n">tile_bonus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">max_tile</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
    
    <span class="c1"># Penalty for game over</span>
    <span class="n">game_over_penalty</span> <span class="o">=</span> <span class="o">-</span><span class="mf">50.0</span> <span class="k">if</span> <span class="n">done</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="c1"># Bonus for keeping high tiles in corners</span>
    <span class="n">corner_bonus</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">max_tile</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">:</span>
        <span class="n">corners</span> <span class="o">=</span> <span class="p">[</span><span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">max_tile</span> <span class="ow">in</span> <span class="n">corners</span><span class="p">:</span>
            <span class="n">corner_bonus</span> <span class="o">=</span> <span class="mf">2.0</span>
    
    <span class="c1"># Bonus for monotonicity (tiles decreasing from corner)</span>
    <span class="n">monotonicity_bonus</span> <span class="o">=</span> <span class="n">calculate_monotonicity</span><span class="p">(</span><span class="n">board</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
    
    <span class="c1"># Penalty for too many small tiles</span>
    <span class="n">small_tile_penalty</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
    
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_reward</span> <span class="o">+</span> <span class="n">tile_bonus</span> <span class="o">+</span> <span class="n">corner_bonus</span> <span class="o">+</span> <span class="n">monotonicity_bonus</span> <span class="o">+</span> <span class="n">small_tile_penalty</span> <span class="o">+</span> <span class="n">game_over_penalty</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calculate_monotonicity</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate how well tiles decrease from corner&quot;&quot;&quot;</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Check horizontal monotonicity</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Check vertical monotonicity  </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">score</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="training-loop">
<h1>Training Loop<a class="headerlink" href="#training-loop" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">training_to_reach_target</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">target_tile</span><span class="p">,</span> <span class="n">max_episodes</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
    <span class="c1"># Training loop with better monitoring</span>
    <span class="n">target_update_freq</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># More frequent updates</span>
    <span class="n">best_tile</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">consecutive_no_improvement</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_episodes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">total_reward</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">episode_training_steps</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
                
            <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">valid_actions</span><span class="p">)</span>
            <span class="n">next_state</span><span class="p">,</span> <span class="n">reward_from_env</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            
            <span class="c1"># Use shaped reward</span>
            <span class="n">shaped_reward</span> <span class="o">=</span> <span class="n">get_shaped_reward</span><span class="p">(</span><span class="n">reward_from_env</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">shaped_reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
            
            <span class="n">total_reward</span> <span class="o">+=</span> <span class="n">shaped_reward</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">next_state</span>
            
            <span class="c1"># Train more frequently</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">agent</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">train_step</span><span class="p">()</span>
                <span class="n">episode_training_steps</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="n">steps</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">agent</span><span class="o">.</span><span class="n">decay_epsilon</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">episode</span> <span class="o">%</span> <span class="n">target_update_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">update_target</span><span class="p">()</span>
    
        
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_tile</span> <span class="o">&gt;</span> <span class="n">best_tile</span><span class="p">:</span>
            <span class="n">best_tile</span> <span class="o">=</span> <span class="n">max_tile</span>
            <span class="n">consecutive_no_improvement</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*** New best tile: </span><span class="si">{</span><span class="n">best_tile</span><span class="si">}</span><span class="s2"> at episode </span><span class="si">{</span><span class="n">episode</span><span class="si">}</span><span class="s2">! ***&quot;</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">q_net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;cnn_dqn_best_</span><span class="si">{</span><span class="n">best_tile</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_tile</span> <span class="o">&gt;=</span> <span class="n">target_tile</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully reached </span><span class="si">{</span><span class="n">target_tile</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">best_tile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">consecutive_no_improvement</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Early stopping if no improvement</span>
        <span class="k">if</span> <span class="n">consecutive_no_improvement</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No improvement for 500 episodes, stopping at tile </span><span class="si">{</span><span class="n">best_tile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">episode</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ep </span><span class="si">{</span><span class="n">episode</span><span class="si">}</span><span class="s2"> | Steps: </span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2"> | Max Tile: </span><span class="si">{</span><span class="n">max_tile</span><span class="si">}</span><span class="s2"> | Reward: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">total_reward</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Epsilon: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">epsilon</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best_tile</span>

<span class="c1"># --- Optimized Training Loop ---</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>  <span class="c1"># Higher learning rate</span>
    <span class="n">gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
    <span class="n">max_memory</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>  <span class="c1"># Larger buffer</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>  <span class="c1"># Larger batches</span>
    <span class="n">epsilon_start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">epsilon_min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">epsilon_decay</span><span class="o">=</span><span class="mf">0.9999</span><span class="p">,</span>  <span class="c1"># Slower decay</span>
    <span class="n">per_alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>  <span class="c1"># Higher priority</span>
    <span class="n">per_beta_start</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">curriculum_training</span><span class="p">():</span>
    <span class="n">target_tiles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span><span class="p">]</span>
    <span class="n">best_tile</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Create agent and environment</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
        <span class="n">max_memory</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">epsilon_start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">epsilon_min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">epsilon_decay</span><span class="o">=</span><span class="mf">0.9999</span><span class="p">,</span>
        <span class="n">per_alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">per_beta_start</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>
    
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">target_tiles</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training to reach </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> tile...&quot;</span><span class="p">)</span>
        <span class="n">current_best</span> <span class="o">=</span> <span class="n">training_to_reach_target</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">best_tile</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">best_tile</span><span class="p">,</span> <span class="n">current_best</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">best_tile</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully reached </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could only reach </span><span class="si">{</span><span class="n">best_tile</span><span class="si">}</span><span class="s2">, stopping curriculum&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final best tile: </span><span class="si">{</span><span class="n">best_tile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">agent</span><span class="p">,</span> <span class="n">best_tile</span>

<span class="c1"># Run the training</span>
<span class="n">agent</span><span class="p">,</span> <span class="n">final_best_tile</span> <span class="o">=</span> <span class="n">curriculum_training</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training to reach 64 tile...
*** New best tile: 128 at episode 1! ***
Successfully reached 64!
Successfully reached 64!
==================================================
Training to reach 128 tile...
*** New best tile: 128 at episode 1! ***
Successfully reached 128!
Successfully reached 128!
==================================================
Training to reach 256 tile...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages/torch/nn/modules/conv.py:549: UserWarning: Using padding=&#39;same&#39; with even kernel lengths and odd dilation may require a zero-padded copy of the input be created (Triggered internally at /Users/runner/work/pytorch/pytorch/pytorch/aten/src/ATen/native/Convolution.cpp:1037.)
  return F.conv2d(
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*** New best tile: 32 at episode 1! ***
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*** New best tile: 64 at episode 2! ***
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">113</span>
<span class="g g-Whitespace">    </span><span class="mi">110</span>     <span class="k">return</span> <span class="n">agent</span><span class="p">,</span> <span class="n">best_tile</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span> <span class="c1"># Run the training</span>
<span class="ne">--&gt; </span><span class="mi">113</span> <span class="n">agent</span><span class="p">,</span> <span class="n">final_best_tile</span> <span class="o">=</span> <span class="n">curriculum_training</span><span class="p">()</span>

<span class="nn">Cell In[4], line 98,</span> in <span class="ni">curriculum_training</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">96</span> <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">target_tiles</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training to reach </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> tile...&quot;</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">98</span>     <span class="n">current_best</span> <span class="o">=</span> <span class="n">training_to_reach_target</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">99</span>     <span class="n">best_tile</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">best_tile</span><span class="p">,</span> <span class="n">current_best</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span>     <span class="k">if</span> <span class="n">best_tile</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>

<span class="nn">Cell In[4], line 32,</span> in <span class="ni">training_to_reach_target</span><span class="nt">(agent, env, target_tile, max_episodes)</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span> <span class="c1"># Train more frequently</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">agent</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">32</span>     <span class="n">agent</span><span class="o">.</span><span class="n">train_step</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span>     <span class="n">episode_training_steps</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span> <span class="n">steps</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nn">Cell In[3], line 284,</span> in <span class="ni">Agent.train_step</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">282</span> <span class="c1"># Update the Q-network</span>
<span class="g g-Whitespace">    </span><span class="mi">283</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">284</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">285</span> <span class="n">gradient_norms</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">286</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

<span class="nn">File ~/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages/torch/_tensor.py:648,</span> in <span class="ni">Tensor.backward</span><span class="nt">(self, gradient, retain_graph, create_graph, inputs)</span>
<span class="g g-Whitespace">    </span><span class="mi">638</span> <span class="k">if</span> <span class="n">has_torch_function_unary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">639</span>     <span class="k">return</span> <span class="n">handle_torch_function</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">640</span>         <span class="n">Tensor</span><span class="o">.</span><span class="n">backward</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">641</span>         <span class="p">(</span><span class="bp">self</span><span class="p">,),</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span>         <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">647</span>     <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">648</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>     <span class="bp">self</span><span class="p">,</span> <span class="n">gradient</span><span class="p">,</span> <span class="n">retain_graph</span><span class="p">,</span> <span class="n">create_graph</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span>
<span class="g g-Whitespace">    </span><span class="mi">650</span> <span class="p">)</span>

<span class="nn">File ~/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages/torch/autograd/__init__.py:353,</span> in <span class="ni">backward</span><span class="nt">(tensors, grad_tensors, retain_graph, create_graph, grad_variables, inputs)</span>
<span class="g g-Whitespace">    </span><span class="mi">348</span>     <span class="n">retain_graph</span> <span class="o">=</span> <span class="n">create_graph</span>
<span class="g g-Whitespace">    </span><span class="mi">350</span> <span class="c1"># The reason we repeat the same comment below is that</span>
<span class="g g-Whitespace">    </span><span class="mi">351</span> <span class="c1"># some Python versions print out the first line of a multi-line function</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span> <span class="c1"># calls in the traceback and some print out the last line</span>
<span class="ne">--&gt; </span><span class="mi">353</span> <span class="n">_engine_run_backward</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">354</span>     <span class="n">tensors</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>     <span class="n">grad_tensors_</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span>     <span class="n">retain_graph</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">357</span>     <span class="n">create_graph</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">358</span>     <span class="n">inputs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">359</span>     <span class="n">allow_unreachable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">360</span>     <span class="n">accumulate_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">361</span> <span class="p">)</span>

<span class="nn">File ~/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages/torch/autograd/graph.py:824,</span> in <span class="ni">_engine_run_backward</span><span class="nt">(t_outputs, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">822</span>     <span class="n">unregister_hooks</span> <span class="o">=</span> <span class="n">_register_logging_hooks_on_whole_graph</span><span class="p">(</span><span class="n">t_outputs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">823</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">824</span>     <span class="k">return</span> <span class="n">Variable</span><span class="o">.</span><span class="n">_execution_engine</span><span class="o">.</span><span class="n">run_backward</span><span class="p">(</span>  <span class="c1"># Calls into the C++ engine to run the backward pass</span>
<span class="g g-Whitespace">    </span><span class="mi">825</span>         <span class="n">t_outputs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">826</span>     <span class="p">)</span>  <span class="c1"># Calls into the C++ engine to run the backward pass</span>
<span class="g g-Whitespace">    </span><span class="mi">827</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">828</span>     <span class="k">if</span> <span class="n">attach_logging_hooks</span><span class="p">:</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<section id="pygame-visualizer-for-dqn-agent">
<h2>2048 PyGame Visualizer for DQN Agent<a class="headerlink" href="#pygame-visualizer-for-dqn-agent" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip3<span class="w"> </span>install<span class="w"> </span>pygame
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: pygame in /Users/saraliu/Library/Caches/pypoetry/virtualenvs/titanic-SA5bcgBn-py3.9/lib/python3.9/site-packages (2.6.1)

<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> A new release of pip is available: <span class=" -Color -Color-Red">24.1</span> -&gt; <span class=" -Color -Color-Green">25.1.1</span>
<span class=" -Color -Color-Bold">[</span><span class=" -Color -Color-Blue">notice</span><span class=" -Color -Color-Bold">]</span> To update, run: <span class=" -Color -Color-Green">pip install --upgrade pip</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pygame</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="c1"># Initialize Pygame</span>
<span class="n">pygame</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="c1"># Constants</span>
<span class="n">SIZE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">TILE_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">MARGIN</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="n">SIZE</span> <span class="o">*</span> <span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">MARGIN</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="n">WIDTH</span>
<span class="n">FONT</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s2">&quot;arial&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

<span class="c1"># Colors</span>
<span class="n">BG_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">187</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span>
<span class="n">TILE_COLORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">205</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span>
    <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="mi">238</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">218</span><span class="p">),</span>
    <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
    <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="mi">242</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">121</span><span class="p">),</span>
    <span class="mi">16</span><span class="p">:</span> <span class="p">(</span><span class="mi">245</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
    <span class="mi">32</span><span class="p">:</span> <span class="p">(</span><span class="mi">246</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
    <span class="mi">64</span><span class="p">:</span> <span class="p">(</span><span class="mi">246</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">59</span><span class="p">),</span>
    <span class="mi">128</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">114</span><span class="p">),</span>
    <span class="mi">256</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">97</span><span class="p">),</span>
    <span class="mi">512</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>
    <span class="mi">1024</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">63</span><span class="p">),</span>
    <span class="mi">2048</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">46</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">TEXT_COLOR_DARK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">119</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">TEXT_COLOR_LIGHT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">249</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">242</span><span class="p">)</span>

<span class="c1"># Create screen</span>
<span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">))</span>
<span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s2">&quot;2048 Visualizer&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_board</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">BG_COLOR</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">TILE_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="n">rect_x</span> <span class="o">=</span> <span class="n">MARGIN</span> <span class="o">+</span> <span class="n">col</span> <span class="o">*</span> <span class="p">(</span><span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="n">MARGIN</span><span class="p">)</span>
            <span class="n">rect_y</span> <span class="o">=</span> <span class="n">MARGIN</span> <span class="o">+</span> <span class="n">row</span> <span class="o">*</span> <span class="p">(</span><span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="n">MARGIN</span><span class="p">)</span>
            <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="n">rect_x</span><span class="p">,</span> <span class="n">rect_y</span><span class="p">,</span> <span class="n">TILE_SIZE</span><span class="p">,</span> <span class="n">TILE_SIZE</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">text_color</span> <span class="o">=</span> <span class="n">TEXT_COLOR_DARK</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">TEXT_COLOR_LIGHT</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">FONT</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">text_color</span><span class="p">)</span>
                <span class="n">text_rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_rect</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">rect_x</span> <span class="o">+</span> <span class="n">TILE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rect_y</span> <span class="o">+</span> <span class="n">TILE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text_rect</span><span class="p">)</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

<span class="c1"># --- Agent Playing Loop ---</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">while</span> <span class="n">running</span><span class="p">:</span>
    <span class="c1"># Handle quit event</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">QUIT</span><span class="p">:</span>
            <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="c1"># Get Q-values from model</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">state_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">encode_board</span><span class="p">(</span><span class="n">state</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># shape: (1, 16)</span>
            <span class="n">q_values</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">q_net</span><span class="p">(</span><span class="n">state_tensor</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># Mask invalid actions</span>
        <span class="n">masked_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">q_values</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="n">masked_q</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_values</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

        <span class="n">action</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">masked_q</span><span class="p">))</span>

        <span class="c1"># Step and draw</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="n">draw_board</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Show game over</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s1">&#39;arial&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Game Over!&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">text_rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_rect</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">WIDTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text_rect</span><span class="p">)</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">pygame</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

<span class="c1"># Log final results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final score:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max tile:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final score: 326
Max tile: 128
</pre></div>
</div>
</div>
</div>
</section>
<section id="expectimax-algorithm">
<h2>Expectimax Algorithm<a class="headerlink" href="#expectimax-algorithm" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">Game2048Env</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the game board and add two initial tiles&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_random_tile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_random_tile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_random_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a random tile (2 or 4) to an empty position&quot;&quot;&quot;</span>
        <span class="n">empty_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_positions</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">empty_positions</span><span class="p">)</span>
        <span class="c1"># 90% chance of 2, 10% chance of 4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="k">else</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">_merge_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge a single line (row or column) to the left</span>
<span class="sd">        Returns: (merged_line, score_gained)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove zeros</span>
        <span class="n">non_zero</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">line</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_zero</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_zero</span><span class="p">)</span> <span class="ow">and</span> <span class="n">non_zero</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">non_zero</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># Merge identical adjacent tiles</span>
                <span class="n">merged_value</span> <span class="o">=</span> <span class="n">non_zero</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged_value</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="n">merged_value</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>  <span class="c1"># Skip the next tile since it was merged</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">non_zero</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Pad with zeros to maintain original length</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">merged</span><span class="p">),</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">_move_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move all tiles left&quot;&quot;&quot;</span>
        <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">new_board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">:],</span> <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_line</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">total_score</span> <span class="o">+=</span> <span class="n">score</span>
            
        <span class="k">return</span> <span class="n">new_board</span><span class="p">,</span> <span class="n">total_score</span>

    <span class="k">def</span> <span class="nf">_move_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move all tiles right&quot;&quot;&quot;</span>
        <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># Reverse, merge left, then reverse back</span>
            <span class="n">reversed_row</span> <span class="o">=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">merged_row</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_line</span><span class="p">(</span><span class="n">reversed_row</span><span class="p">)</span>
            <span class="n">new_board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">merged_row</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">total_score</span> <span class="o">+=</span> <span class="n">score</span>
            
        <span class="k">return</span> <span class="n">new_board</span><span class="p">,</span> <span class="n">total_score</span>

    <span class="k">def</span> <span class="nf">_move_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move all tiles up&quot;&quot;&quot;</span>
        <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">new_board</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span> <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_line</span><span class="p">(</span><span class="n">board</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])</span>
            <span class="n">total_score</span> <span class="o">+=</span> <span class="n">score</span>
            
        <span class="k">return</span> <span class="n">new_board</span><span class="p">,</span> <span class="n">total_score</span>

    <span class="k">def</span> <span class="nf">_move_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move all tiles down&quot;&quot;&quot;</span>
        <span class="n">new_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># Reverse, merge up, then reverse back</span>
            <span class="n">reversed_col</span> <span class="o">=</span> <span class="n">board</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">merged_col</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_line</span><span class="p">(</span><span class="n">reversed_col</span><span class="p">)</span>
            <span class="n">new_board</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_col</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">total_score</span> <span class="o">+=</span> <span class="n">score</span>
            
        <span class="k">return</span> <span class="n">new_board</span><span class="p">,</span> <span class="n">total_score</span>

    <span class="k">def</span> <span class="nf">_execute_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a move on the board</span>
<span class="sd">        Actions: 0=UP, 1=DOWN, 2=LEFT, 3=RIGHT</span>
<span class="sd">        Returns: (new_board, score_gained)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1"># UP</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_up</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># DOWN</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_down</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># LEFT</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_left</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># RIGHT</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_right</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">. Must be 0-3.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute one game step</span>
<span class="sd">        Returns: (new_state, reward, done, info)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{}</span>

        <span class="c1"># Try to execute the move</span>
        <span class="n">new_board</span><span class="p">,</span> <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        
        <span class="c1"># Check if the move actually changed the board</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">):</span>
            <span class="c1"># Invalid move - board didn&#39;t change</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">,</span> <span class="p">{}</span>
        
        <span class="c1"># Valid move - update board and add new tile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">new_board</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_random_tile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="n">reward</span>
        
        <span class="c1"># Check if game is over</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_game_over</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">reward</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">,</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_valid_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of valid actions (0=UP, 1=DOWN, 2=LEFT, 3=RIGHT)&quot;&quot;&quot;</span>
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">):</span>
                <span class="n">valid_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="n">valid_actions</span>

    <span class="k">def</span> <span class="nf">is_game_over</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the game is over (no valid moves)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">get_max_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the highest tile value on the board&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_board</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print the current board state&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current board:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Score: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max tile: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid actions: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test the fixed implementation</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> 
    <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Original board:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Test all directions</span>
<span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;UP&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;DOWN&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;LEFT&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;RIGHT&quot;</span><span class="p">)]:</span>
    <span class="n">new_board</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> move:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">new_board</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Score gained: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Board changed: </span><span class="si">{</span><span class="ow">not</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original board:
[[   2    2    4    8]
 [  16   32   64  128]
 [ 256  512 1024 2048]
 [  16    8    2    2]]

UP move:
[[   2    2    4    8]
 [  16   32   64  128]
 [ 256  512 1024 2048]
 [  16    8    2    2]]
Score gained: 0
Board changed: False

DOWN move:
[[   2    2    4    8]
 [  16   32   64  128]
 [ 256  512 1024 2048]
 [  16    8    2    2]]
Score gained: 0
Board changed: False

LEFT move:
[[   4    4    8    0]
 [  16   32   64  128]
 [ 256  512 1024 2048]
 [  16    8    4    0]]
Score gained: 8
Board changed: True

RIGHT move:
[[   0    4    4    8]
 [  16   32   64  128]
 [ 256  512 1024 2048]
 [   0   16    8    4]]
Score gained: 8
Board changed: True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExpectimaxAgent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="c1"># Create a temporary environment for move simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the best action using expectimax algorithm&quot;&quot;&quot;</span>
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># No valid actions, return default</span>
        
        <span class="n">_</span><span class="p">,</span> <span class="n">best_move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Ensure the best move is valid, otherwise pick first valid action</span>
        <span class="k">return</span> <span class="n">best_move</span> <span class="k">if</span> <span class="n">best_move</span> <span class="ow">in</span> <span class="n">valid_actions</span> <span class="k">else</span> <span class="n">valid_actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_valid_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get valid actions for a given board state&quot;&quot;&quot;</span>
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
                <span class="n">valid_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid_actions</span>

    <span class="k">def</span> <span class="nf">expectimax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">is_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expectimax algorithm implementation</span>
<span class="sd">        is_max: True for player turn (maximizing), False for random tile placement (expectation)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">is_max</span><span class="p">:</span>
            <span class="c1"># Player&#39;s turn - maximize</span>
            <span class="n">best_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
            <span class="n">best_move</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>  <span class="c1"># 0=UP, 1=DOWN, 2=LEFT, 3=RIGHT</span>
                <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>  <span class="c1"># Valid move</span>
                    <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">best_value</span><span class="p">:</span>
                        <span class="n">best_value</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">best_move</span> <span class="o">=</span> <span class="n">action</span>
                        
            <span class="k">return</span> <span class="n">best_value</span> <span class="k">if</span> <span class="n">best_move</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">),</span> <span class="n">best_move</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Random tile placement - expectation</span>
            <span class="n">empty_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_positions</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="kc">None</span>

            <span class="n">expected_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="n">empty_positions</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tile_value</span><span class="p">,</span> <span class="n">probability</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)]:</span>
                    <span class="n">new_board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">new_board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_value</span>
                    <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">expected_value</span> <span class="o">+=</span> <span class="n">probability</span> <span class="o">*</span> <span class="n">value</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">empty_positions</span><span class="p">)</span>
                    
            <span class="k">return</span> <span class="n">expected_value</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the board state is terminal (game over)&quot;&quot;&quot;</span>
        <span class="c1"># Game is terminal if no empty spaces and no valid moves</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Still has empty spaces</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">(</span><span class="n">board</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluation function for board states</span>
<span class="sd">        Consider multiple factors for better play</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1000</span>  <span class="c1"># Game over is bad</span>
            
        <span class="c1"># Basic evaluation components</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">empty_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Monotonicity bonus (higher tiles should be in corners/edges)</span>
        <span class="n">monotonicity_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_monotonicity</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Smoothness bonus (adjacent tiles should have similar values)</span>
        <span class="n">smoothness_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_smoothness</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Weighted combination</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">max_tile</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">+</span>           <span class="c1"># Favor higher tiles</span>
            <span class="n">empty_tiles</span> <span class="o">*</span> <span class="mf">2.7</span> <span class="o">+</span>        <span class="c1"># Favor more empty spaces</span>
            <span class="n">monotonicity_score</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">+</span>  <span class="c1"># Favor monotonic arrangements</span>
            <span class="n">smoothness_score</span> <span class="o">*</span> <span class="mf">0.1</span>      <span class="c1"># Favor smooth transitions</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">calculate_monotonicity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate monotonicity score - prefer tiles arranged in order&quot;&quot;&quot;</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># up, down, left, right</span>
        
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">next_pos</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">next_pos</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">next_pos</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">next_pos</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">next_pos</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">next_pos</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">next_pos</span> <span class="o">-=</span> <span class="mi">1</span>
                
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">current</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">next_pos</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">current_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">current</span><span class="p">])</span>
                    <span class="n">next_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">next_pos</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">current_value</span> <span class="o">&gt;</span> <span class="n">next_value</span><span class="p">:</span>
                        <span class="n">totals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">next_value</span> <span class="o">-</span> <span class="n">current_value</span>
                    <span class="k">elif</span> <span class="n">next_value</span> <span class="o">&gt;</span> <span class="n">current_value</span><span class="p">:</span>
                        <span class="n">totals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">current_value</span> <span class="o">-</span> <span class="n">next_value</span>
                        
                <span class="n">current</span> <span class="o">=</span> <span class="n">next_pos</span>
                <span class="n">next_pos</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">next_pos</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">next_pos</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">next_pos</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">next_pos</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">next_pos</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">next_pos</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">next_pos</span> <span class="o">-=</span> <span class="mi">1</span>
                    
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">next_pos</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">current_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">current</span><span class="p">][</span><span class="n">y</span><span class="p">])</span>
                    <span class="n">next_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">next_pos</span><span class="p">][</span><span class="n">y</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">current_value</span> <span class="o">&gt;</span> <span class="n">next_value</span><span class="p">:</span>
                        <span class="n">totals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">next_value</span> <span class="o">-</span> <span class="n">current_value</span>
                    <span class="k">elif</span> <span class="n">next_value</span> <span class="o">&gt;</span> <span class="n">current_value</span><span class="p">:</span>
                        <span class="n">totals</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">current_value</span> <span class="o">-</span> <span class="n">next_value</span>
                        
                <span class="n">current</span> <span class="o">=</span> <span class="n">next_pos</span>
                <span class="n">next_pos</span> <span class="o">+=</span> <span class="mi">1</span>
                
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">totals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">totals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">totals</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">totals</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">calculate_smoothness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate smoothness score - prefer similar adjacent values&quot;&quot;&quot;</span>
        <span class="n">smoothness</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">])</span>
                    <span class="c1"># Check right neighbor</span>
                    <span class="k">if</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">target_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">smoothness</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">target_value</span><span class="p">)</span>
                    <span class="c1"># Check down neighbor  </span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">target_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">])</span>
                        <span class="n">smoothness</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">target_value</span><span class="p">)</span>
                        
        <span class="k">return</span> <span class="n">smoothness</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test the updated ExpectimaxAgent</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">ExpectimaxAgent</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> 
    <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Board:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid actions: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent&#39;s choice: </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Actions: 0=UP, 1=DOWN, 2=LEFT, 3=RIGHT</span>
<span class="n">action_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;UP&quot;</span><span class="p">,</span> <span class="s2">&quot;DOWN&quot;</span><span class="p">,</span> <span class="s2">&quot;LEFT&quot;</span><span class="p">,</span> <span class="s2">&quot;RIGHT&quot;</span><span class="p">]</span>
<span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent chooses: </span><span class="si">{</span><span class="n">action_names</span><span class="p">[</span><span class="n">action</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Board:
[[   2    2    4    8]
 [  16   32   64  128]
 [ 256  512 1024 2048]
 [  16    8    2    2]]
Valid actions: [2, 3]
Agent&#39;s choice: 3
Agent chooses: RIGHT
</pre></div>
</div>
</div>
</div>
</section>
<section id="pygame-visualizer-for-expectimax-algorithm">
<h2>PyGame Visualizer for Expectimax Algorithm<a class="headerlink" href="#pygame-visualizer-for-expectimax-algorithm" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pygame</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># Initialize Pygame</span>
<span class="n">pygame</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="c1"># Constants</span>
<span class="n">SIZE</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">TILE_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">MARGIN</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="n">SIZE</span> <span class="o">*</span> <span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">MARGIN</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="n">WIDTH</span>
<span class="n">FONT</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s2">&quot;arial&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

<span class="c1"># Colors</span>
<span class="n">BG_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">187</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span>
<span class="n">TILE_COLORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">205</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span>
    <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="mi">238</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">218</span><span class="p">),</span>
    <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
    <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="mi">242</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">121</span><span class="p">),</span>
    <span class="mi">16</span><span class="p">:</span> <span class="p">(</span><span class="mi">245</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
    <span class="mi">32</span><span class="p">:</span> <span class="p">(</span><span class="mi">246</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
    <span class="mi">64</span><span class="p">:</span> <span class="p">(</span><span class="mi">246</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">59</span><span class="p">),</span>
    <span class="mi">128</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">114</span><span class="p">),</span>
    <span class="mi">256</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">97</span><span class="p">),</span>
    <span class="mi">512</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>
    <span class="mi">1024</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">63</span><span class="p">),</span>
    <span class="mi">2048</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">46</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">TEXT_COLOR_DARK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">119</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">TEXT_COLOR_LIGHT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">249</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">242</span><span class="p">)</span>

<span class="c1"># Setup display</span>
<span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">))</span>
<span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s2">&quot;2048 Expectimax&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_board</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">BG_COLOR</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">TILE_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
            <span class="n">rect_x</span> <span class="o">=</span> <span class="n">MARGIN</span> <span class="o">+</span> <span class="n">col</span> <span class="o">*</span> <span class="p">(</span><span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="n">MARGIN</span><span class="p">)</span>
            <span class="n">rect_y</span> <span class="o">=</span> <span class="n">MARGIN</span> <span class="o">+</span> <span class="n">row</span> <span class="o">*</span> <span class="p">(</span><span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="n">MARGIN</span><span class="p">)</span>
            <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="n">rect_x</span><span class="p">,</span> <span class="n">rect_y</span><span class="p">,</span> <span class="n">TILE_SIZE</span><span class="p">,</span> <span class="n">TILE_SIZE</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">text_color</span> <span class="o">=</span> <span class="n">TEXT_COLOR_DARK</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">TEXT_COLOR_LIGHT</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">FONT</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">text_color</span><span class="p">)</span>
                <span class="n">text_rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_rect</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">rect_x</span> <span class="o">+</span> <span class="n">TILE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rect_y</span> <span class="o">+</span> <span class="n">TILE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text_rect</span><span class="p">)</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

<span class="c1"># --- Expectimax playing loop ---</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">ExpectimaxAgent</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">while</span> <span class="n">running</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">QUIT</span><span class="p">:</span>
            <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">draw_board</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expectimax chose invalid action, picking random.&quot;</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span>

        <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s1">&#39;arial&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Game Over!&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">text_rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_rect</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">WIDTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text_rect</span><span class="p">)</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">pygame</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final score:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max tile:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final score: 1608
Max tile: 1024
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SuperExpectimaxAgent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
        
        <span class="c1"># Memoization for speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memo_hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memo_misses</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get best action using advanced expectimax&quot;&quot;&quot;</span>
        <span class="c1"># Clear memo periodically to prevent memory issues</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">best_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
        <span class="n">best_action</span> <span class="o">=</span> <span class="n">valid_actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">best_value</span><span class="p">:</span>
                <span class="n">best_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">best_action</span> <span class="o">=</span> <span class="n">action</span>
                
        <span class="k">return</span> <span class="n">best_action</span>

    <span class="k">def</span> <span class="nf">get_valid_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get valid actions&quot;&quot;&quot;</span>
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
                <span class="n">valid_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid_actions</span>

    <span class="k">def</span> <span class="nf">expectimax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">is_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expectimax with memoization&quot;&quot;&quot;</span>
        <span class="c1"># Create hash for memoization</span>
        <span class="n">board_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
        <span class="n">memo_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">board_hash</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">is_max</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">memo_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memo_hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">memo_key</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">memo_misses</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">memo_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">is_max</span><span class="p">:</span>
            <span class="n">best_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
            <span class="n">best_move</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
                <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">best_value</span><span class="p">:</span>
                    <span class="n">best_value</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">best_move</span> <span class="o">=</span> <span class="n">action</span>
                    
            <span class="n">result</span> <span class="o">=</span> <span class="n">best_value</span> <span class="k">if</span> <span class="n">best_move</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">),</span> <span class="n">best_move</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">empty_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_positions</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expected_value</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="n">empty_positions</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tile_value</span><span class="p">,</span> <span class="n">probability</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)]:</span>
                        <span class="n">new_board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">new_board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_value</span>
                        <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">expected_value</span> <span class="o">+=</span> <span class="n">probability</span> <span class="o">*</span> <span class="n">value</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">empty_positions</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">expected_value</span><span class="p">,</span> <span class="kc">None</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">memo_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if game is over&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">(</span><span class="n">board</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MUCH BETTER evaluation function for reaching 2048</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">100000</span>  <span class="c1"># Severe penalty for game over</span>
            
        <span class="c1"># Core metrics</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">empty_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># 1. CORNER STRATEGY - This is crucial!</span>
        <span class="n">corner_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_corner_score</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># 2. SNAKE PATTERN - Keep tiles in monotonic order</span>
        <span class="n">snake_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_snake_score</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># 3. EDGE WEIGHT - Prefer high tiles on edges</span>
        <span class="n">edge_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_edge_score</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># 4. CLUSTERING - Penalize scattered high tiles</span>
        <span class="n">clustering_penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_clustering_penalty</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># 5. MERGE POTENTIAL - Reward potential merges</span>
        <span class="n">merge_potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_merge_potential</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># 6. SMOOTHNESS - Penalize large gaps between adjacent tiles</span>
        <span class="n">smoothness_penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_smoothness_penalty</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># OPTIMIZED WEIGHTS for reaching 2048</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">max_tile</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">+</span>                    <span class="c1"># Base tile value</span>
            <span class="n">empty_tiles</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">+</span>               <span class="c1"># Empty spaces are CRUCIAL</span>
            <span class="n">corner_score</span> <span class="o">*</span> <span class="mf">1000.0</span> <span class="o">+</span>             <span class="c1"># Corner strategy is KEY</span>
            <span class="n">snake_score</span> <span class="o">*</span> <span class="mf">200.0</span> <span class="o">+</span>               <span class="c1"># Snake pattern helps a lot</span>
            <span class="n">edge_score</span> <span class="o">*</span> <span class="mf">50.0</span> <span class="o">+</span>                 <span class="c1"># Edge preference</span>
            <span class="n">clustering_penalty</span> <span class="o">*</span> <span class="o">-</span><span class="mf">500.0</span> <span class="o">+</span>       <span class="c1"># Avoid scattered tiles</span>
            <span class="n">merge_potential</span> <span class="o">*</span> <span class="mf">80.0</span> <span class="o">+</span>            <span class="c1"># Reward merge opportunities</span>
            <span class="n">smoothness_penalty</span> <span class="o">*</span> <span class="o">-</span><span class="mf">30.0</span>          <span class="c1"># Smooth transitions</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">calculate_corner_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced corner scoring&quot;&quot;&quot;</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Find position of max tile</span>
        <span class="n">max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="n">board</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="c1"># HUGE bonus if max tile is in corner</span>
        <span class="k">if</span> <span class="n">max_pos</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)]:</span>
            <span class="n">bonus</span> <span class="o">=</span> <span class="n">max_val</span> <span class="o">*</span> <span class="mi">10</span>
            
            <span class="c1"># Extra bonus for specific corner preferences</span>
            <span class="k">if</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># Top-left preferred</span>
                <span class="n">bonus</span> <span class="o">*=</span> <span class="mf">1.5</span>
            <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># Bottom-left second choice</span>
                <span class="n">bonus</span> <span class="o">*=</span> <span class="mf">1.3</span>
                
            <span class="k">return</span> <span class="n">bonus</span>
        
        <span class="c1"># Medium bonus if on edge</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">max_pos</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">max_val</span> <span class="o">*</span> <span class="mi">3</span>
            
        <span class="c1"># Penalty if in middle</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">max_val</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">calculate_snake_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate snake pattern score&quot;&quot;&quot;</span>
        <span class="c1"># Define snake patterns from each corner</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;top_left&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s1">&#39;top_right&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s1">&#39;bottom_left&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s1">&#39;bottom_right&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">}</span>
        
        <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">r1</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">r2</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">c2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Reward decreasing pattern</span>
                    <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">board</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">c2</span><span class="p">]:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">c2</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">]</span> <span class="o">-</span> <span class="n">board</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">c2</span><span class="p">])</span>
                        
            <span class="n">best_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">best_score</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">best_score</span>

    <span class="k">def</span> <span class="nf">calculate_edge_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reward high values on edges&quot;&quot;&quot;</span>
        <span class="n">edge_score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Top and bottom edges</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">edge_score</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Top edge</span>
            <span class="n">edge_score</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Bottom edge</span>
            
        <span class="c1"># Left and right edges  </span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">edge_score</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Left edge</span>
            <span class="n">edge_score</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Right edge</span>
            
        <span class="k">return</span> <span class="n">edge_score</span>

    <span class="k">def</span> <span class="nf">calculate_clustering_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Penalize high tiles that are isolated&quot;&quot;&quot;</span>
        <span class="n">penalty</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">:</span>  <span class="c1"># High tiles</span>
                    <span class="c1"># Check if surrounded by much smaller tiles</span>
                    <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dc</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]:</span>
                        <span class="n">nr</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="n">dr</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="n">dc</span>
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">nc</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">nr</span><span class="p">,</span> <span class="n">nc</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">neighbors</span><span class="p">:</span>
                        <span class="n">avg_neighbor</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">avg_neighbor</span> <span class="o">&lt;</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Much smaller neighbors</span>
                            <span class="n">penalty</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                            
        <span class="k">return</span> <span class="n">penalty</span>

    <span class="k">def</span> <span class="nf">calculate_merge_potential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate potential for merges&quot;&quot;&quot;</span>
        <span class="n">potential</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Check horizontal merges</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">potential</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                    
        <span class="c1"># Check vertical merges</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]:</span>
                    <span class="n">potential</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                    
        <span class="k">return</span> <span class="n">potential</span>

    <span class="k">def</span> <span class="nf">calculate_smoothness_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Penalty for rough transitions&quot;&quot;&quot;</span>
        <span class="n">penalty</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Quadratic penalty</span>
                    
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]))</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Quadratic penalty</span>
                    
        <span class="k">return</span> <span class="n">penalty</span>

<span class="c1"># Test the super agent</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Testing Super Expectimax Agent ===&quot;</span><span class="p">)</span>
<span class="n">super_agent</span> <span class="o">=</span> <span class="n">SuperExpectimaxAgent</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Quick test function</span>
<span class="k">def</span> <span class="nf">quick_test_agent</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">max_moves</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quick test without visualization&quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">moves</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">while</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">done</span> <span class="ow">and</span> <span class="n">moves</span> <span class="o">&lt;</span> <span class="n">max_moves</span><span class="p">:</span>
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="k">break</span>
            
        <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="n">moves</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Print progress</span>
        <span class="k">if</span> <span class="n">moves</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Move </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2">: Max tile = </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="c1"># Stop if we reach 2048!</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ðŸŽ‰ SUCCESS! Reached 2048 in </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2"> moves! ðŸŽ‰&quot;</span><span class="p">)</span>
            <span class="k">break</span>
    
    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">(),</span> <span class="n">env</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">moves</span>

<span class="c1"># Run the test</span>
<span class="n">max_tile</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">moves</span> <span class="o">=</span> <span class="n">quick_test_agent</span><span class="p">(</span><span class="n">super_agent</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final results: Max tile = </span><span class="si">{</span><span class="n">max_tile</span><span class="si">}</span><span class="s2">, Score = </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">, Moves = </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">super_agent</span><span class="p">,</span> <span class="s1">&#39;memo_hits&#39;</span><span class="p">):</span>
    <span class="n">total_calls</span> <span class="o">=</span> <span class="n">super_agent</span><span class="o">.</span><span class="n">memo_hits</span> <span class="o">+</span> <span class="n">super_agent</span><span class="o">.</span><span class="n">memo_misses</span>
    <span class="n">hit_rate</span> <span class="o">=</span> <span class="n">super_agent</span><span class="o">.</span><span class="n">memo_hits</span> <span class="o">/</span> <span class="n">total_calls</span> <span class="k">if</span> <span class="n">total_calls</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memoization hit rate: </span><span class="si">{</span><span class="n">hit_rate</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">super_agent</span><span class="o">.</span><span class="n">memo_hits</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_calls</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Testing Super Expectimax Agent ===
Move 100: Max tile = 128
Move 200: Max tile = 256
Move 300: Max tile = 512
Move 400: Max tile = 512
Move 500: Max tile = 1024
Move 600: Max tile = 1024
Move 700: Max tile = 1024
Move 800: Max tile = 1024
Move 900: Max tile = 1024
Final results: Max tile = 1024, Score = 15612, Moves = 921
Memoization hit rate: 50.16% (1704027/3397286)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UltimateExpectimaxAgent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
        
        <span class="c1"># Advanced memoization with better cache management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memo_hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memo_misses</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Adaptive depth based on game state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_depth</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Endgame detection threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endgame_threshold</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># When fewer than 8 empty spaces</span>
        
        <span class="c1"># Opening book for early game</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opening_moves</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Start by going to corners</span>
            <span class="nb">hash</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()):</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># LEFT</span>
            <span class="nb">hash</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()):</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># DOWN</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced action selection with adaptive strategies&quot;&quot;&quot;</span>
        <span class="c1"># Clear memo periodically</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            
        <span class="c1"># Check opening book first</span>
        <span class="n">board_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">board_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opening_moves</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opening_moves</span><span class="p">[</span><span class="n">board_hash</span><span class="p">]</span>
            
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="c1"># Adaptive depth based on game state</span>
        <span class="n">current_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adaptive_depth</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="n">best_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
        <span class="n">best_action</span> <span class="o">=</span> <span class="n">valid_actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Try actions in smart order (corner-preserving moves first)</span>
        <span class="n">ordered_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_actions</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">valid_actions</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">ordered_actions</span><span class="p">:</span>
            <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">current_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">best_value</span><span class="p">:</span>
                <span class="n">best_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">best_action</span> <span class="o">=</span> <span class="n">action</span>
                
        <span class="k">return</span> <span class="n">best_action</span>

    <span class="k">def</span> <span class="nf">get_adaptive_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adjust search depth based on game state&quot;&quot;&quot;</span>
        <span class="n">empty_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Deeper search in critical situations</span>
        <span class="k">if</span> <span class="n">empty_tiles</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Endgame</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">empty_tiles</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>  <span class="c1"># Mid-late game</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">max_tile</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">:</span>  <span class="c1"># High value tiles present</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Early game</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">order_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">valid_actions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Order actions by priority (corner-preserving first)&quot;&quot;&quot;</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="n">board</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="c1"># Priority based on max tile position</span>
        <span class="k">if</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># Top-left corner</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># LEFT, DOWN, UP, RIGHT</span>
        <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>  <span class="c1"># Top-right corner</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># RIGHT, DOWN, UP, LEFT</span>
        <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># Bottom-left corner</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># LEFT, UP, DOWN, RIGHT</span>
        <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>  <span class="c1"># Bottom-right corner</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># RIGHT, UP, DOWN, LEFT</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Max tile not in corner - try to move it there</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Default to LEFT priority</span>
            
        <span class="c1"># Sort valid actions by priority</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">priority</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">priority</span> <span class="k">else</span> <span class="mi">999</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">expectimax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">is_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced expectimax with alpha-beta style pruning&quot;&quot;&quot;</span>
        <span class="n">board_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
        <span class="n">memo_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">board_hash</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">is_max</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">memo_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memo_hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">memo_key</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">memo_misses</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">memo_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">is_max</span><span class="p">:</span>
            <span class="n">best_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
            <span class="n">best_move</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_actions</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">(</span><span class="n">board</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">best_value</span><span class="p">:</span>
                    <span class="n">best_value</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">best_move</span> <span class="o">=</span> <span class="n">action</span>
                    
            <span class="n">result</span> <span class="o">=</span> <span class="n">best_value</span> <span class="k">if</span> <span class="n">best_move</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">),</span> <span class="n">best_move</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">empty_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_positions</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expected_value</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Sample fewer positions if too many empty tiles (performance optimization)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">empty_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">empty_positions</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">empty_positions</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
                    
                <span class="k">for</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="n">empty_positions</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tile_value</span><span class="p">,</span> <span class="n">probability</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)]:</span>
                        <span class="n">new_board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">new_board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_value</span>
                        <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">expected_value</span> <span class="o">+=</span> <span class="n">probability</span> <span class="o">*</span> <span class="n">value</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">empty_positions</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">expected_value</span><span class="p">,</span> <span class="kc">None</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">memo_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_valid_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get valid actions&quot;&quot;&quot;</span>
        <span class="n">valid_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
                <span class="n">valid_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid_actions</span>

    <span class="k">def</span> <span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced terminal detection&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">(</span><span class="n">board</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ULTIMATE evaluation function - heavily tuned for 2048</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1000000</span>  <span class="c1"># Massive penalty for game over</span>
            
        <span class="n">empty_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># CRITICAL: If we&#39;re close to 2048, prioritize that above all else</span>
        <span class="k">if</span> <span class="n">max_tile</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_endgame</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Core components</span>
        <span class="n">corner_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_corner_score</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">snake_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_snake_score</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">edge_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_edge_score</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">clustering_penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_clustering_penalty</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">merge_potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_merge_potential</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">smoothness_penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_smoothness_penalty</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># TUNED WEIGHTS - heavily favor corner strategy and empty spaces</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">max_tile</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">+</span>                    
            <span class="n">empty_tiles</span> <span class="o">*</span> <span class="mf">200.0</span> <span class="o">+</span>               <span class="c1"># INCREASED: Empty spaces crucial</span>
            <span class="n">corner_score</span> <span class="o">*</span> <span class="mf">2000.0</span> <span class="o">+</span>             <span class="c1"># INCREASED: Corner strategy essential</span>
            <span class="n">snake_score</span> <span class="o">*</span> <span class="mf">300.0</span> <span class="o">+</span>               <span class="c1"># INCREASED: Snake pattern</span>
            <span class="n">edge_score</span> <span class="o">*</span> <span class="mf">75.0</span> <span class="o">+</span>                 
            <span class="n">clustering_penalty</span> <span class="o">*</span> <span class="o">-</span><span class="mf">800.0</span> <span class="o">+</span>       <span class="c1"># INCREASED: Avoid scattered tiles</span>
            <span class="n">merge_potential</span> <span class="o">*</span> <span class="mf">150.0</span> <span class="o">+</span>           <span class="c1"># INCREASED: Merge opportunities</span>
            <span class="n">smoothness_penalty</span> <span class="o">*</span> <span class="o">-</span><span class="mf">50.0</span>          
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">score</span>

    <span class="k">def</span> <span class="nf">evaluate_endgame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Special evaluation for when max tile &gt;= 1024&quot;&quot;&quot;</span>
        <span class="n">empty_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Find the 1024 tile position</span>
        <span class="n">max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="n">board</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="c1"># MASSIVE bonus if 1024 is in corner</span>
        <span class="k">if</span> <span class="n">max_pos</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)]:</span>
            <span class="n">corner_bonus</span> <span class="o">=</span> <span class="n">max_tile</span> <span class="o">*</span> <span class="mi">50</span>  <span class="c1"># 50x multiplier!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">corner_bonus</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_tile</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Heavy penalty if not in corner</span>
            
        <span class="c1"># Check for 1024 merge potential (path to 2048!)</span>
        <span class="n">merge_1024_bonus</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dc</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]:</span>
            <span class="n">nr</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">max_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dr</span><span class="p">,</span> <span class="n">max_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dc</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">nc</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">nr</span><span class="p">,</span> <span class="n">nc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">512</span><span class="p">:</span>  <span class="c1"># Can merge to make 2048!</span>
                    <span class="n">merge_1024_bonus</span> <span class="o">=</span> <span class="mi">100000</span>  <span class="c1"># HUGE bonus</span>
                    <span class="k">break</span>
        
        <span class="c1"># Conservative play - preserve empty spaces at all costs</span>
        <span class="n">empty_bonus</span> <span class="o">=</span> <span class="n">empty_tiles</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># 5x normal weight</span>
        
        <span class="c1"># Penalize any risky moves heavily</span>
        <span class="n">risk_penalty</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">empty_tiles</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">risk_penalty</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50000</span>  <span class="c1"># Very risky state</span>
        <span class="k">elif</span> <span class="n">empty_tiles</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">risk_penalty</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span>  <span class="c1"># Somewhat risky</span>
            
        <span class="k">return</span> <span class="n">corner_bonus</span> <span class="o">+</span> <span class="n">merge_1024_bonus</span> <span class="o">+</span> <span class="n">empty_bonus</span> <span class="o">+</span> <span class="n">risk_penalty</span>

    <span class="c1"># [Keep all the existing heuristic methods but with small improvements]</span>
    <span class="k">def</span> <span class="nf">calculate_corner_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced corner scoring with stronger preferences&quot;&quot;&quot;</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="n">board</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">max_pos</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)]:</span>
            <span class="n">bonus</span> <span class="o">=</span> <span class="n">max_val</span> <span class="o">*</span> <span class="mi">15</span>  <span class="c1"># Increased from 10</span>
            <span class="k">if</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># Top-left preferred</span>
                <span class="n">bonus</span> <span class="o">*=</span> <span class="mf">2.0</span>  <span class="c1"># Increased from 1.5</span>
            <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># Bottom-left second choice</span>
                <span class="n">bonus</span> <span class="o">*=</span> <span class="mf">1.8</span>  <span class="c1"># Increased from 1.3</span>
            <span class="k">return</span> <span class="n">bonus</span>
        
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">max_pos</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">max_val</span> <span class="o">*</span> <span class="mi">5</span>  <span class="c1"># Increased from 3</span>
            
        <span class="k">return</span> <span class="o">-</span><span class="n">max_val</span> <span class="o">*</span> <span class="mi">5</span>  <span class="c1"># Increased penalty from 2</span>

    <span class="k">def</span> <span class="nf">calculate_snake_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep existing implementation&quot;&quot;&quot;</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;top_left&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">}</span>
        
        <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">r1</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">r2</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">c2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">board</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">c2</span><span class="p">]:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">c2</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">]</span> <span class="o">-</span> <span class="n">board</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span> <span class="n">c2</span><span class="p">])</span>
                        
            <span class="n">best_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">best_score</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">best_score</span>

    <span class="k">def</span> <span class="nf">calculate_edge_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep existing implementation&quot;&quot;&quot;</span>
        <span class="n">edge_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">edge_score</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">edge_score</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">edge_score</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">edge_score</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">edge_score</span>

    <span class="k">def</span> <span class="nf">calculate_clustering_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep existing implementation&quot;&quot;&quot;</span>
        <span class="n">penalty</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">:</span>
                    <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dc</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]:</span>
                        <span class="n">nr</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="n">dr</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="n">dc</span>
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">nc</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">nr</span><span class="p">,</span> <span class="n">nc</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">neighbors</span><span class="p">:</span>
                        <span class="n">avg_neighbor</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">avg_neighbor</span> <span class="o">&lt;</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">penalty</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">penalty</span>

    <span class="k">def</span> <span class="nf">calculate_merge_potential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced to prioritize high-value merges&quot;&quot;&quot;</span>
        <span class="n">potential</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">merge_value</span> <span class="o">=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                    <span class="c1"># Extra bonus for high-value merges</span>
                    <span class="k">if</span> <span class="n">merge_value</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">:</span>
                        <span class="n">potential</span> <span class="o">+=</span> <span class="n">merge_value</span> <span class="o">*</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">potential</span> <span class="o">+=</span> <span class="n">merge_value</span>
                        
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]:</span>
                    <span class="n">merge_value</span> <span class="o">=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">merge_value</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">:</span>
                        <span class="n">potential</span> <span class="o">+=</span> <span class="n">merge_value</span> <span class="o">*</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">potential</span> <span class="o">+=</span> <span class="n">merge_value</span>
                        
        <span class="k">return</span> <span class="n">potential</span>

    <span class="k">def</span> <span class="nf">calculate_smoothness_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep existing implementation&quot;&quot;&quot;</span>
        <span class="n">penalty</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span>
                    
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]))</span>
                    <span class="n">penalty</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">penalty</span>

<span class="c1"># Test multiple runs to find best strategy</span>
<span class="k">def</span> <span class="nf">test_multiple_runs</span><span class="p">(</span><span class="n">agent_class</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run multiple games and report statistics&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Run </span><span class="si">{</span><span class="n">run</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_runs</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">agent_class</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">moves</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">done</span> <span class="ow">and</span> <span class="n">moves</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
                <span class="k">break</span>
                
            <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">moves</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">moves</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Move </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2">: Max tile = </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ðŸŽ‰ SUCCESS! Reached 2048 in </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2"> moves! ðŸŽ‰&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max_tile&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">(),</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
            <span class="s1">&#39;moves&#39;</span><span class="p">:</span> <span class="n">moves</span><span class="p">,</span>
            <span class="s1">&#39;reached_2048&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span>
        <span class="p">}</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result: Max tile = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;max_tile&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Score = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Print summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== SUMMARY OF </span><span class="si">{</span><span class="n">num_runs</span><span class="si">}</span><span class="s2"> RUNS ===&quot;</span><span class="p">)</span>
    <span class="n">max_tiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;max_tile&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="n">success_rate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;reached_2048&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">num_runs</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success rate (2048): </span><span class="si">{</span><span class="n">success_rate</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average max tile: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best max tile: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best score: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Run the ultimate test</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Testing Ultimate Expectimax Agent ===&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">test_multiple_runs</span><span class="p">(</span><span class="n">UltimateExpectimaxAgent</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Testing Ultimate Expectimax Agent ===

=== Run 1/3 ===
Move 200: Max tile = 256
Move 400: Max tile = 512
Move 600: Max tile = 1024
Move 800: Max tile = 1024
ðŸŽ‰ SUCCESS! Reached 2048 in 980 moves! ðŸŽ‰
Result: Max tile = 2048, Score = 20436

=== Run 2/3 ===
Move 200: Max tile = 256
Move 400: Max tile = 512
Move 600: Max tile = 512
Move 800: Max tile = 1024
Result: Max tile = 1024, Score = 15148

=== Run 3/3 ===
Move 200: Max tile = 256
Move 400: Max tile = 512
Move 600: Max tile = 512
Result: Max tile = 512, Score = 11016

=== SUMMARY OF 3 RUNS ===
Success rate (2048): 33.3%
Average max tile: 1195
Best max tile: 2048
Average score: 15533
Best score: 20436
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pygame visualization for the fixed agent</span>
<span class="kn">import</span> <span class="nn">pygame</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">visualize_agent_gameplay</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize agent playing with pygame&quot;&quot;&quot;</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    
    <span class="c1"># Constants</span>
    <span class="n">SIZE</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">TILE_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">MARGIN</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">WIDTH</span> <span class="o">=</span> <span class="n">SIZE</span> <span class="o">*</span> <span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">MARGIN</span>
    <span class="n">HEIGHT</span> <span class="o">=</span> <span class="n">WIDTH</span> <span class="o">+</span> <span class="mi">100</span>  <span class="c1"># Extra space for text</span>
    <span class="n">FONT</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s2">&quot;arial&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">INFO_FONT</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s2">&quot;arial&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>

    <span class="c1"># Colors</span>
    <span class="n">BG_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">187</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span>
    <span class="n">TILE_COLORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">205</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="mi">238</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">218</span><span class="p">),</span> <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
        <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="mi">242</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">121</span><span class="p">),</span> <span class="mi">16</span><span class="p">:</span> <span class="p">(</span><span class="mi">245</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span> <span class="mi">32</span><span class="p">:</span> <span class="p">(</span><span class="mi">246</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="mi">64</span><span class="p">:</span> <span class="p">(</span><span class="mi">246</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">59</span><span class="p">),</span> <span class="mi">128</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">114</span><span class="p">),</span> <span class="mi">256</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">97</span><span class="p">),</span>
        <span class="mi">512</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="mi">1024</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">63</span><span class="p">),</span> <span class="mi">2048</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">46</span><span class="p">),</span>
        <span class="mi">4096</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">46</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">TEXT_COLOR_DARK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">119</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
    <span class="n">TEXT_COLOR_LIGHT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">249</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">242</span><span class="p">)</span>

    <span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">))</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s2">&quot;2048 AI Agent&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_game_state</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">move_count</span><span class="p">):</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">BG_COLOR</span><span class="p">)</span>
        
        <span class="c1"># Draw board</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">TILE_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
                <span class="n">rect_x</span> <span class="o">=</span> <span class="n">MARGIN</span> <span class="o">+</span> <span class="n">col</span> <span class="o">*</span> <span class="p">(</span><span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="n">MARGIN</span><span class="p">)</span>
                <span class="n">rect_y</span> <span class="o">=</span> <span class="n">MARGIN</span> <span class="o">+</span> <span class="n">row</span> <span class="o">*</span> <span class="p">(</span><span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="n">MARGIN</span><span class="p">)</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="n">rect_x</span><span class="p">,</span> <span class="n">rect_y</span><span class="p">,</span> <span class="n">TILE_SIZE</span><span class="p">,</span> <span class="n">TILE_SIZE</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">text_color</span> <span class="o">=</span> <span class="n">TEXT_COLOR_DARK</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">TEXT_COLOR_LIGHT</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">FONT</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">text_color</span><span class="p">)</span>
                    <span class="n">text_rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_rect</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">rect_x</span> <span class="o">+</span> <span class="n">TILE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rect_y</span> <span class="o">+</span> <span class="n">TILE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text_rect</span><span class="p">)</span>
        
        <span class="c1"># Draw info</span>
        <span class="n">info_y</span> <span class="o">=</span> <span class="n">WIDTH</span> <span class="o">+</span> <span class="mi">10</span>
        <span class="n">info_text</span> <span class="o">=</span> <span class="n">INFO_FONT</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Move: </span><span class="si">{</span><span class="n">move_count</span><span class="si">}</span><span class="s2"> | Score: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">score</span><span class="si">}</span><span class="s2"> | Max: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">info_text</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">info_y</span><span class="p">))</span>
        
        <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="c1"># Run game</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">move_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">while</span> <span class="n">running</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">QUIT</span><span class="p">:</span>
                <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="n">move_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">draw_game_state</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">move_count</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ðŸŽ‰ REACHED 2048! ðŸŽ‰&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="c1"># Show final result</span>
    <span class="n">final_font</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s1">&#39;arial&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">final_font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">&quot;SUCCESS! Reached 2048!&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">final_font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Game Over. Max: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    
    <span class="n">text_rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_rect</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">WIDTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text_rect</span><span class="p">)</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">pygame</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">(),</span> <span class="n">env</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">move_count</span>

<span class="c1"># Run visualization</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting visual gameplay...&quot;</span><span class="p">)</span>
<span class="n">max_tile</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">moves</span> <span class="o">=</span> <span class="n">visualize_agent_gameplay</span><span class="p">(</span><span class="n">super_agent</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final result: Max tile = </span><span class="si">{</span><span class="n">max_tile</span><span class="si">}</span><span class="s2">, Score = </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">, Moves = </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting visual gameplay...
Final result: Max tile = 256, Score = 5956, Moves = 439
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pygame visualization for the fixed agent</span>
<span class="kn">import</span> <span class="nn">pygame</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">visualize_agent_gameplay</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize agent playing with pygame&quot;&quot;&quot;</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    
    <span class="c1"># Constants</span>
    <span class="n">SIZE</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">TILE_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">MARGIN</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">WIDTH</span> <span class="o">=</span> <span class="n">SIZE</span> <span class="o">*</span> <span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="p">(</span><span class="n">SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">MARGIN</span>
    <span class="n">HEIGHT</span> <span class="o">=</span> <span class="n">WIDTH</span> <span class="o">+</span> <span class="mi">100</span>  <span class="c1"># Extra space for text</span>
    <span class="n">FONT</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s2">&quot;arial&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">INFO_FONT</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s2">&quot;arial&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>

    <span class="c1"># Colors</span>
    <span class="n">BG_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">187</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span>
    <span class="n">TILE_COLORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">205</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="mi">238</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">218</span><span class="p">),</span> <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
        <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="mi">242</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">121</span><span class="p">),</span> <span class="mi">16</span><span class="p">:</span> <span class="p">(</span><span class="mi">245</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span> <span class="mi">32</span><span class="p">:</span> <span class="p">(</span><span class="mi">246</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
        <span class="mi">64</span><span class="p">:</span> <span class="p">(</span><span class="mi">246</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">59</span><span class="p">),</span> <span class="mi">128</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">114</span><span class="p">),</span> <span class="mi">256</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">97</span><span class="p">),</span>
        <span class="mi">512</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="mi">1024</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">63</span><span class="p">),</span> <span class="mi">2048</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">46</span><span class="p">),</span>
        <span class="mi">4096</span><span class="p">:</span> <span class="p">(</span><span class="mi">237</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">46</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">TEXT_COLOR_DARK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">119</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
    <span class="n">TEXT_COLOR_LIGHT</span> <span class="o">=</span> <span class="p">(</span><span class="mi">249</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">242</span><span class="p">)</span>

    <span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">))</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s2">&quot;2048 AI Agent&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_game_state</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">move_count</span><span class="p">):</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">BG_COLOR</span><span class="p">)</span>
        
        <span class="c1"># Draw board</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SIZE</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">TILE_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
                <span class="n">rect_x</span> <span class="o">=</span> <span class="n">MARGIN</span> <span class="o">+</span> <span class="n">col</span> <span class="o">*</span> <span class="p">(</span><span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="n">MARGIN</span><span class="p">)</span>
                <span class="n">rect_y</span> <span class="o">=</span> <span class="n">MARGIN</span> <span class="o">+</span> <span class="n">row</span> <span class="o">*</span> <span class="p">(</span><span class="n">TILE_SIZE</span> <span class="o">+</span> <span class="n">MARGIN</span><span class="p">)</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="n">rect_x</span><span class="p">,</span> <span class="n">rect_y</span><span class="p">,</span> <span class="n">TILE_SIZE</span><span class="p">,</span> <span class="n">TILE_SIZE</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">text_color</span> <span class="o">=</span> <span class="n">TEXT_COLOR_DARK</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">TEXT_COLOR_LIGHT</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">FONT</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">text_color</span><span class="p">)</span>
                    <span class="n">text_rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_rect</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">rect_x</span> <span class="o">+</span> <span class="n">TILE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rect_y</span> <span class="o">+</span> <span class="n">TILE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text_rect</span><span class="p">)</span>
        
        <span class="c1"># Draw info</span>
        <span class="n">info_y</span> <span class="o">=</span> <span class="n">WIDTH</span> <span class="o">+</span> <span class="mi">10</span>
        <span class="n">info_text</span> <span class="o">=</span> <span class="n">INFO_FONT</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Move: </span><span class="si">{</span><span class="n">move_count</span><span class="si">}</span><span class="s2"> | Score: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">score</span><span class="si">}</span><span class="s2"> | Max: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">info_text</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">info_y</span><span class="p">))</span>
        
        <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="c1"># Run game</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">move_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">while</span> <span class="n">running</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">QUIT</span><span class="p">:</span>
                <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="n">move_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">draw_game_state</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">move_count</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ðŸŽ‰ REACHED 2048! ðŸŽ‰&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="c1"># Show final result</span>
    <span class="n">final_font</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">SysFont</span><span class="p">(</span><span class="s1">&#39;arial&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">final_font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">&quot;SUCCESS! Reached 2048!&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">final_font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Game Over. Max: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    
    <span class="n">text_rect</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get_rect</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">WIDTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">HEIGHT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text_rect</span><span class="p">)</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">pygame</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">(),</span> <span class="n">env</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">move_count</span>

<span class="c1"># Run visualization</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting visual gameplay...&quot;</span><span class="p">)</span>
<span class="n">max_tile</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">moves</span> <span class="o">=</span> <span class="n">visualize_agent_gameplay</span><span class="p">(</span><span class="n">super_agent</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final result: Max tile = </span><span class="si">{</span><span class="n">max_tile</span><span class="si">}</span><span class="s2">, Score = </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">, Moves = </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting visual gameplay...
Final result: Max tile = 256, Score = 5956, Moves = 439
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="k">class</span> <span class="nc">MCTSNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_chance</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>  <span class="c1"># Action that led to this node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_chance</span> <span class="o">=</span> <span class="n">is_chance</span>  <span class="c1"># True if this is a chance node (random tile placement)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">untried_actions</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_chance</span><span class="p">:</span>
            <span class="c1"># Player node - actions are moves</span>
            <span class="n">temp_env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
            <span class="n">temp_env</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">untried_actions</span> <span class="o">=</span> <span class="n">temp_env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Chance node - actions are tile placements</span>
            <span class="n">empty_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">untried_actions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">pos</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">empty_positions</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
    
    <span class="k">def</span> <span class="nf">is_fully_expanded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">untried_actions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_chance</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">temp_env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
        <span class="n">temp_env</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">temp_env</span><span class="o">.</span><span class="n">is_game_over</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_average_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">visits</span>

<span class="k">class</span> <span class="nc">MCTS2048Agent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">exploration_weight</span><span class="o">=</span><span class="mf">1.4</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploration_weight</span> <span class="o">=</span> <span class="n">exploration_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the best action using MCTS&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Endgame - use more iterations</span>
            <span class="n">iterations</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span>
            
        <span class="n">root</span> <span class="o">=</span> <span class="n">MCTSNode</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">is_chance</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="c1"># Selection and Expansion</span>
            <span class="n">leaf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_and_expand</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            
            <span class="c1"># Simulation</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulate</span><span class="p">(</span><span class="n">leaf</span><span class="p">)</span>
            
            <span class="c1"># Backpropagation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backpropagate</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span>
        
        <span class="c1"># Choose best action</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="c1"># Fallback to random valid action</span>
            <span class="n">temp_env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
            <span class="n">temp_env</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">temp_env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span> <span class="k">if</span> <span class="n">valid_actions</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">best_child</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">visits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_child</span><span class="o">.</span><span class="n">action</span>
    
    <span class="k">def</span> <span class="nf">_select_and_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select and expand using UCB1&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_fully_expanded</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_child</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>
    
    <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expand the node by adding a new child&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">untried_actions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span>
            
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_chance</span><span class="p">:</span>
            <span class="c1"># Chance node - add tile placement</span>
            <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">untried_actions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_board</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">MCTSNode</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="p">((</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">value</span><span class="p">),</span> <span class="n">is_chance</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Player node - add move</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">untried_actions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">MCTSNode</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">is_chance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">child</span>
    
    <span class="k">def</span> <span class="nf">_select_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select child using UCB1 formula&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_chance</span><span class="p">:</span>
            <span class="c1"># For chance nodes, select proportionally to probability</span>
            <span class="c1"># Favor 2-tiles (90%) over 4-tiles (10%)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># 2-tile</span>
                    <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># 4-tile</span>
                    <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            
            <span class="c1"># Weighted random selection</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For player nodes, use UCB1</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ucb1_value</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">visits</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_ucb1_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">parent_visits</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate UCB1 value for child selection&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">visits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        
        <span class="n">exploitation</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_average_value</span><span class="p">()</span>
        <span class="n">exploration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploration_weight</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">parent_visits</span><span class="p">)</span> <span class="o">/</span> <span class="n">child</span><span class="o">.</span><span class="n">visits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exploitation</span> <span class="o">+</span> <span class="n">exploration</span>
    
    <span class="k">def</span> <span class="nf">_simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate a random rollout from the node&quot;&quot;&quot;</span>
        <span class="n">current_board</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">current_board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">moves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_moves</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Limit simulation length</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">done</span> <span class="ow">and</span> <span class="n">moves</span> <span class="o">&lt;</span> <span class="n">max_moves</span><span class="p">:</span>
            <span class="n">valid_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
                <span class="k">break</span>
                
            <span class="c1"># Use intelligent random policy for simulation</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intelligent_random_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">valid_actions</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">moves</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Return evaluation of final state</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_board</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_intelligent_random_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">valid_actions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Smart random policy that prefers corner-preserving moves&quot;&quot;&quot;</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="n">board</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="c1"># Prioritize moves that keep max tile in corner</span>
        <span class="k">if</span> <span class="n">max_pos</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">2</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">:</span>  <span class="c1"># Prefer LEFT</span>
                <span class="k">return</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.7</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">:</span>  <span class="c1"># Prefer RIGHT</span>
                <span class="k">return</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.7</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">2</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">:</span>  <span class="c1"># Prefer LEFT</span>
                <span class="k">return</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.7</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">:</span>  <span class="c1"># Prefer RIGHT</span>
                <span class="k">return</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.7</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_backpropagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">reward</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Backpropagate the reward up the tree&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">visits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">node</span><span class="o">.</span><span class="n">value_sum</span> <span class="o">+=</span> <span class="n">reward</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
    
    <span class="k">def</span> <span class="nf">_evaluate_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced evaluation function for MCTS&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">100000</span>  <span class="c1"># Game over</span>
        
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">empty_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Massive bonus for reaching 2048!</span>
        <span class="k">if</span> <span class="n">max_tile</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="n">empty_tiles</span> <span class="o">*</span> <span class="mi">10000</span>
        
        <span class="c1"># Strong bonuses for high tiles</span>
        <span class="n">tile_bonus</span> <span class="o">=</span> <span class="n">max_tile</span> <span class="o">*</span> <span class="mi">2</span>
        
        <span class="c1"># Corner bonus</span>
        <span class="n">max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="n">board</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">corner_bonus</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">max_pos</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)]:</span>
            <span class="n">corner_bonus</span> <span class="o">=</span> <span class="n">max_tile</span> <span class="o">*</span> <span class="mi">10</span>
            <span class="k">if</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># Prefer top-left</span>
                <span class="n">corner_bonus</span> <span class="o">*=</span> <span class="mf">1.5</span>
        
        <span class="c1"># Empty space bonus</span>
        <span class="n">empty_bonus</span> <span class="o">=</span> <span class="n">empty_tiles</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Monotonicity bonus</span>
        <span class="n">monotonicity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_monotonicity</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Merge potential</span>
        <span class="n">merge_potential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_merge_potential</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">tile_bonus</span> <span class="o">+</span> <span class="n">corner_bonus</span> <span class="o">+</span> <span class="n">empty_bonus</span> <span class="o">+</span> <span class="n">monotonicity</span> <span class="o">*</span> <span class="mi">50</span> <span class="o">+</span> <span class="n">merge_potential</span> <span class="o">*</span> <span class="mi">20</span>
    
    <span class="k">def</span> <span class="nf">_calculate_monotonicity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate monotonicity score&quot;&quot;&quot;</span>
        <span class="c1"># Check for decreasing sequences from top-left</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Horizontal monotonicity</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Vertical monotonicity</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">score</span>
    
    <span class="k">def</span> <span class="nf">_calculate_merge_potential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate merge potential&quot;&quot;&quot;</span>
        <span class="n">potential</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Horizontal merges</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">potential</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        
        <span class="c1"># Vertical merges</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]:</span>
                    <span class="n">potential</span> <span class="o">+=</span> <span class="n">board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">potential</span>

<span class="c1"># Hybrid agent that combines MCTS with Expectimax for different situations</span>
<span class="k">class</span> <span class="nc">HybridAgent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcts_agent</span> <span class="o">=</span> <span class="n">MCTS2048Agent</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expectimax_agent</span> <span class="o">=</span> <span class="n">UltimateExpectimaxAgent</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose between MCTS and Expectimax based on game state&quot;&quot;&quot;</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">empty_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Use MCTS for critical endgame situations</span>
        <span class="k">if</span> <span class="n">max_tile</span> <span class="o">&gt;=</span> <span class="mi">512</span> <span class="ow">and</span> <span class="n">empty_tiles</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcts_agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Use MCTS when we have 1024 tile (close to winning)</span>
        <span class="k">if</span> <span class="n">max_tile</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcts_agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Use Expectimax for early/mid game</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax_agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>

<span class="c1"># Enhanced test function with detailed analysis</span>
<span class="k">def</span> <span class="nf">detailed_test_runs</span><span class="p">(</span><span class="n">agent_class</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run detailed tests with more analysis&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Run </span><span class="si">{</span><span class="n">run</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_runs</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">agent_class</span> <span class="o">==</span> <span class="n">HybridAgent</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="n">agent_class</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="n">agent_class</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">agent_class</span><span class="p">(),</span> <span class="s1">&#39;iterations&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">agent_class</span><span class="p">()</span>
        
        <span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">moves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">move_history</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">done</span> <span class="ow">and</span> <span class="n">moves</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="p">:</span>  <span class="c1"># Increased move limit</span>
            <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
                <span class="k">break</span>
                
            <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            
            <span class="n">move_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;move&#39;</span><span class="p">:</span> <span class="n">moves</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;max_tile&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">(),</span>
                <span class="s1">&#39;empty_tiles&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">score</span>
            <span class="p">})</span>
            
            <span class="n">moves</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">moves</span> <span class="o">%</span> <span class="mi">300</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Move </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2">: Max=</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span><span class="si">}</span><span class="s2">, Empty=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, Score=</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ðŸŽ‰ SUCCESS! Reached 2048 in </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2"> moves! ðŸŽ‰&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max_tile&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">(),</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
            <span class="s1">&#39;moves&#39;</span><span class="p">:</span> <span class="n">moves</span><span class="p">,</span>
            <span class="s1">&#39;reached_2048&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">,</span>
            <span class="s1">&#39;move_history&#39;</span><span class="p">:</span> <span class="n">move_history</span>
        <span class="p">}</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result: Max tile = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;max_tile&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Score = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Moves = </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Detailed analysis</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== DETAILED ANALYSIS OF </span><span class="si">{</span><span class="n">num_runs</span><span class="si">}</span><span class="s2"> RUNS ===&quot;</span><span class="p">)</span>
    <span class="n">max_tiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;max_tile&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="n">moves_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;moves&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="n">success_rate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;reached_2048&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">num_runs</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success rate (2048): </span><span class="si">{</span><span class="n">success_rate</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average max tile: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> (min: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span><span class="si">}</span><span class="s2">, max: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> (min: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="si">}</span><span class="s2">, max: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average moves: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">moves_list</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> (min: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">moves_list</span><span class="p">)</span><span class="si">}</span><span class="s2">, max: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">moves_list</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="c1"># Count how often each max tile was reached</span>
    <span class="n">tile_counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="n">max_tiles</span><span class="p">:</span>
        <span class="n">tile_counts</span><span class="p">[</span><span class="n">tile</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tile distribution:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tile</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tile_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">tile</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">tile_counts</span><span class="p">[</span><span class="n">tile</span><span class="p">]</span><span class="si">}</span><span class="s2"> times (</span><span class="si">{</span><span class="n">tile_counts</span><span class="p">[</span><span class="n">tile</span><span class="p">]</span><span class="o">/</span><span class="n">num_runs</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Test different agents</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Testing MCTS Agent ===&quot;</span><span class="p">)</span>
<span class="n">mcts_results</span> <span class="o">=</span> <span class="n">detailed_test_runs</span><span class="p">(</span><span class="n">MCTS2048Agent</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Testing Hybrid Agent ===&quot;</span><span class="p">)</span>
<span class="n">hybrid_results</span> <span class="o">=</span> <span class="n">detailed_test_runs</span><span class="p">(</span><span class="n">HybridAgent</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Testing MCTS Agent ===

=== Run 1/5 ===
Result: Max tile = 32, Score = 212, Moves = 43

=== Run 2/5 ===
Move 300: Max=512, Empty=1, Score=4464
Result: Max tile = 512, Score = 5564, Moves = 385

=== Run 3/5 ===
Result: Max tile = 32, Score = 504, Moves = 76

=== Run 4/5 ===
Move 300: Max=512, Empty=2, Score=4452
Result: Max tile = 512, Score = 4680, Moves = 319

=== Run 5/5 ===
Result: Max tile = 256, Score = 2372, Moves = 202

=== DETAILED ANALYSIS OF 5 RUNS ===
Success rate (2048): 0.0%
Average max tile: 269 (min: 32, max: 512)
Average score: 2666 (min: 212, max: 5564)
Average moves: 205 (min: 43, max: 385)

Tile distribution:
  512: 2 times (40.0%)
  256: 1 times (20.0%)
  32: 2 times (40.0%)

==================================================
=== Testing Hybrid Agent ===

=== Run 1/5 ===
Move 300: Max=512, Empty=0, Score=4448
Result: Max tile = 512, Score = 5084, Moves = 354

=== Run 2/5 ===
Move 300: Max=512, Empty=4, Score=4496
Result: Max tile = 512, Score = 5284, Moves = 369

=== Run 3/5 ===
Move 300: Max=512, Empty=1, Score=4408
Result: Max tile = 512, Score = 4544, Moves = 313

=== Run 4/5 ===
Move 300: Max=512, Empty=4, Score=4540
Result: Max tile = 512, Score = 5304, Moves = 364

=== Run 5/5 ===
Move 300: Max=256, Empty=2, Score=4012
Result: Max tile = 512, Score = 5332, Moves = 367

=== DETAILED ANALYSIS OF 5 RUNS ===
Success rate (2048): 0.0%
Average max tile: 512 (min: 512, max: 512)
Average score: 5110 (min: 4544, max: 5332)
Average moves: 353 (min: 313, max: 369)

Tile distribution:
  512: 5 times (100.0%)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EnhancedMCTS2048Agent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">exploration_weight</span><span class="o">=</span><span class="mf">1.4</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploration_weight</span> <span class="o">=</span> <span class="n">exploration_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
        
        <span class="c1"># Import sophisticated evaluation from UltimateExpectimaxAgent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expectimax_evaluator</span> <span class="o">=</span> <span class="n">UltimateExpectimaxAgent</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced MCTS with better search strategy&quot;&quot;&quot;</span>
        <span class="n">empty_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Adaptive iterations based on game state</span>
        <span class="k">if</span> <span class="n">max_tile</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="n">iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Critical endgame</span>
        <span class="k">elif</span> <span class="n">empty_tiles</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>  <span class="c1"># Late game</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span>
            
        <span class="n">root</span> <span class="o">=</span> <span class="n">MCTSNode</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">is_chance</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">leaf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_and_expand</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhanced_simulate</span><span class="p">(</span><span class="n">leaf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backpropagate</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="c1"># Fallback to Expectimax action</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax_evaluator</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        
        <span class="c1"># Choose child with best average value (not just most visits)</span>
        <span class="n">best_child</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">get_average_value</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">visits</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">best_child</span><span class="o">.</span><span class="n">action</span>
    
    <span class="k">def</span> <span class="nf">_enhanced_simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Much better simulation using strategic rollout policy&quot;&quot;&quot;</span>
        <span class="n">current_board</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">current_board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">moves</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_moves</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Shorter but higher quality rollouts</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">done</span> <span class="ow">and</span> <span class="n">moves</span> <span class="o">&lt;</span> <span class="n">max_moves</span><span class="p">:</span>
            <span class="n">valid_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
                <span class="k">break</span>
                
            <span class="c1"># Use strategic policy instead of random</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategic_rollout_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">valid_actions</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">moves</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Use sophisticated evaluation function</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expectimax_evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_strategic_rollout_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">valid_actions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Strategic rollout that uses 2048 domain knowledge&quot;&quot;&quot;</span>
        <span class="n">max_tile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="n">max_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">board</span><span class="p">),</span> <span class="n">board</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">empty_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Priority order based on game state</span>
        <span class="n">action_priorities</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Corner preservation strategy</span>
        <span class="k">if</span> <span class="n">max_pos</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># Top-left corner</span>
                <span class="n">action_priorities</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># Prefer LEFT, DOWN</span>
            <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># Top-right corner  </span>
                <span class="n">action_priorities</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># Prefer RIGHT, DOWN</span>
            <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># Bottom-left corner</span>
                <span class="n">action_priorities</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># Prefer LEFT, UP</span>
            <span class="k">elif</span> <span class="n">max_pos</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># Bottom-right corner</span>
                <span class="n">action_priorities</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># Prefer RIGHT, UP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Max tile not in corner - prioritize moving it there</span>
            <span class="n">action_priorities</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># Default: prefer LEFT/DOWN</span>
        
        <span class="c1"># Filter by valid actions and create weighted choice</span>
        <span class="n">valid_priorities</span> <span class="o">=</span> <span class="p">[(</span><span class="n">action</span><span class="p">,</span> <span class="n">action_priorities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_priorities</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span>
            
        <span class="n">actions</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">valid_priorities</span><span class="p">)</span>
        
        <span class="c1"># Add some randomness but bias toward good moves</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>  <span class="c1"># 80% strategic, 20% random</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">)</span>

    <span class="c1"># Keep existing MCTS tree operations but with minor improvements</span>
    <span class="k">def</span> <span class="nf">_select_and_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enhanced selection with better exploration&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">is_fully_expanded</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhanced_select_child</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>
    
    <span class="k">def</span> <span class="nf">_enhanced_select_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Better child selection with domain knowledge&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_chance</span><span class="p">:</span>
            <span class="c1"># For chance nodes, proportional to tile probability</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># 2-tile (90% probability)</span>
                    <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># 4-tile (10% probability)</span>
                    <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Enhanced UCB1 with action preferences</span>
            <span class="k">def</span> <span class="nf">enhanced_ucb1</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">visits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                
                <span class="n">exploitation</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_average_value</span><span class="p">()</span>
                <span class="n">exploration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploration_weight</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">visits</span><span class="p">)</span> <span class="o">/</span> <span class="n">child</span><span class="o">.</span><span class="n">visits</span><span class="p">)</span>
                
                <span class="c1"># Add slight bias toward corner-preserving moves</span>
                <span class="n">action_bias</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>  <span class="c1"># LEFT, DOWN preferred</span>
                    <span class="n">action_bias</span> <span class="o">=</span> <span class="mi">100</span>
                <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># UP</span>
                    <span class="n">action_bias</span> <span class="o">=</span> <span class="mi">50</span>
                <span class="c1"># RIGHT gets no bonus (action 3)</span>
                
                <span class="k">return</span> <span class="n">exploitation</span> <span class="o">+</span> <span class="n">exploration</span> <span class="o">+</span> <span class="n">action_bias</span>
            
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">enhanced_ucb1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep existing expand logic&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">untried_actions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span>
            
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_chance</span><span class="p">:</span>
            <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">untried_actions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_board</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_board</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">MCTSNode</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="p">((</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">value</span><span class="p">),</span> <span class="n">is_chance</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">untried_actions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_board</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_env</span><span class="o">.</span><span class="n">_execute_move</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">MCTSNode</span><span class="p">(</span><span class="n">new_board</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">is_chance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">child</span>
    
    <span class="k">def</span> <span class="nf">_backpropagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">reward</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Keep existing backpropagation&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">visits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">node</span><span class="o">.</span><span class="n">value_sum</span> <span class="o">+=</span> <span class="n">reward</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>

<span class="c1"># Test the enhanced MCTS</span>
<span class="k">def</span> <span class="nf">test_enhanced_mcts</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Testing Enhanced MCTS Agent ===&quot;</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">EnhancedMCTS2048Agent</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Run </span><span class="si">{</span><span class="n">run</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/3 ===&quot;</span><span class="p">)</span>
        
        <span class="n">env</span> <span class="o">=</span> <span class="n">Game2048Env</span><span class="p">()</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">moves</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">done</span> <span class="ow">and</span> <span class="n">moves</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="n">valid_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_valid_actions</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
                <span class="k">break</span>
                
            <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="p">)</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">moves</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">moves</span> <span class="o">%</span> <span class="mi">300</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Move </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2">: Max=</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span><span class="si">}</span><span class="s2">, Empty=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">board</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ðŸŽ‰ ENHANCED MCTS SUCCESS! Reached 2048 in </span><span class="si">{</span><span class="n">moves</span><span class="si">}</span><span class="s2"> moves! ðŸŽ‰&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max_tile&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">(),</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> 
            <span class="s1">&#39;moves&#39;</span><span class="p">:</span> <span class="n">moves</span><span class="p">,</span>
            <span class="s1">&#39;reached_2048&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">get_max_tile</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2048</span>
        <span class="p">}</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result: Max tile = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;max_tile&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Score = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Summary</span>
    <span class="n">max_tiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;max_tile&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="n">success_rate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;reached_2048&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== ENHANCED MCTS SUMMARY ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success rate (2048): </span><span class="si">{</span><span class="n">success_rate</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average max tile: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best max tile: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">max_tiles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Run the test</span>
<span class="n">enhanced_results</span> <span class="o">=</span> <span class="n">test_enhanced_mcts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Testing Enhanced MCTS Agent ===

=== Run 1/3 ===
Result: Max tile = 128, Score = 1172

=== Run 2/3 ===
Result: Max tile = 64, Score = 500

=== Run 3/3 ===
Result: Max tile = 64, Score = 752

=== ENHANCED MCTS SUMMARY ===
Success rate (2048): 0.0%
Average max tile: 85
Best max tile: 128
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./2048-solver"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Game 2048 Environment and DQN Agent</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#training-loop">Training Loop</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pygame-visualizer-for-dqn-agent">2048 PyGame Visualizer for DQN Agent</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expectimax-algorithm">Expectimax Algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pygame-visualizer-for-expectimax-algorithm">PyGame Visualizer for Expectimax Algorithm</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>